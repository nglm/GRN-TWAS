# Developer Guide for GRN-TWAS

## Overview

GRN-TWAS is a modular Python package for performing gene regulatory network (GRN) reconstruction and transcriptome-wide association studies (TWAS). The package is organized into several scripts, each responsible for a distinct step in the pipeline: 1. structure learning, 2. model training, 3. association testing. In addition, a main pipeline script allows for reproducible and extensible analyses.

## Directory Structure

```
GRN-TWAS/
├── README.md
├── requirements.txt
├── results/
│   ├── enrichment_results_DisGeNET.csv
│   └── enrichment_results_DisGeNET.xlsx
└── src/
    ├── association_test.py
    ├── grn_twas_main.py
    ├── model_training.py
    ├── structure_learning.py
```

- **results/**: Output directory for results generated by the pipeline.
- **src/**: Source code for all pipeline steps and utilities.

## File Summaries

### `src/structure_learning.py`

- **Purpose**: Reconstructs gene regulatory networks (GRNs) from gene expression and genotype data using the Findr library.
- **Key Functions**:
  - `calculate_posteriors`: Computes posterior probabilities for network edges using Findr.
  - `reconstruct_grn`: Loads data, runs GRN inference, filters edges, saves results and graph statistics.
- **Usage**: Run as a standalone script or via the main pipeline. Requires input data in CSV format and the Findr library path.

### `src/model_training.py`

- **Purpose**: Trains Ridge regression models to predict gene expression based on cis and trans genetic effects, using the reconstructed GRN.
- **Key Functions**:
  - `load_graph`: Loads the GRN graph from a pickle file.
  - `get_y_data`, `get_x_data`: Extracts expression and genotype data for modeling.
  - `train_ridge`: Fits Ridge regression models for cis and trans components.
  - `optimize_weights`: Finds optimal weights for combining cis and trans predictions.
  - `process_dataset`: Orchestrates model training for all genes and saves results.
- **Usage**: Run as a standalone script or via the main pipeline. Requires expression, genotype, and graph files.

### `src/association_test.py`

- **Purpose**: Performs gene-disease association analysis using trained models and GWAS summary statistics.
- **Key Functions**:
  - `load_graph`: Loads the GRN graph.
  - `get_x_data`: Extracts genotype data for association testing.
  - `calculate_z_score`: Computes Z-scores for gene-disease associations.
  - `process_association`: Runs association analysis for all genes and saves results.
- **Usage**: Run as a standalone script or via the main pipeline. Requires expression, genotype, graph, and GWAS files.

### `src/grn_twas_main.py`

- **Purpose**: Orchestrates the entire GRN-TWAS pipeline, running structure learning, model training, and association testing in sequence.
- **Key Functions**:
  - `run_structure_learning`: Calls the structure learning step.
  - `run_model_training`: Calls the model training step.
  - `run_association_test`: Calls the association testing step.
  - `main`: Parses arguments and runs the full pipeline.
- **Usage**: Run this script to execute the full pipeline. Accepts command-line arguments for all required input files and output directory.

## How to Use the Package

### 1. Install Dependencies

Install all required Python packages:

```bash
pip install -r requirements.txt
```

### 2. Prepare Input Data

- **Expression Data**: CSV file with gene expression values (rows: genes, columns: samples).
- **Genotype Data**: CSV file with genotype values (rows: SNPs, columns: samples).
- **GWAS Data**: Tab-delimited file with GWAS summary statistics (SNP IDs, effect sizes, standard errors).

### 3. Run the Pipeline

Use the main pipeline script to run all steps:

```bash
python src/grn_twas_main.py \
  --expression_file <expression.csv> \
  --genotype_file <genotype.csv> \
  --gwas_file <gwas.txt> \
  --output_folder results/
```

This will:

- Reconstruct the GRN and save it in `results/structure/`
- Train models and save them in `results/model_training/`
- Perform association testing and save results in `results/association/`

### 4. Run Individual Steps separately

Each step can be run separately:

- **Structure Learning**:

  ```bash
  python src/structure_learning.py --input_file <expression.csv> --output_folder results/structure --findr_path <path_to_findr> --posterior_threshold 0.75
  ```

- **Model Training**:

  ```bash
  python src/model_training.py --expression_file <expression.csv> --genotype_file <genotype.csv> --graph_file results/structure/graph.pkl --output_folder results/model_training
  ```

- **Association Testing**:

  ```bash
  python src/association_test.py --expression_file <expression.csv> --genotype_file <genotype.csv> --graph_file results/structure/graph.pkl --gwas_file <gwas.txt> --output_file results/association/association_results.json
  ```

